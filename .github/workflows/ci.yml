# GitHub Actions CI/CD Workflow for HexGrid
# This workflow builds the solution, runs tests, generates coverage reports, and publishes test results

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'testing/**'
      - 'feature/**'
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '*.md'
      - 'docs/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'
  SOLUTION_PATH: 'HexGrid.sln'
  TEST_PROJECT: 'HexGrid.Tests/HexGrid.Tests.csproj'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.0.0
      with:
        versionSpec: '6.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v3.0.0
      with:
        useConfigFile: true
        configFilePath: GitVersion.yml

    - name: Display GitVersion Output
      run: |
        echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
        echo "AssemblySemVer: ${{ steps.gitversion.outputs.assemblySemVer }}"
        echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"
        echo "NuGetVersion: ${{ steps.gitversion.outputs.nuGetVersion }}"
        echo "Major: ${{ steps.gitversion.outputs.major }}"
        echo "Minor: ${{ steps.gitversion.outputs.minor }}"
        echo "Patch: ${{ steps.gitversion.outputs.patch }}"
        echo "PreReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}"
        echo "CommitsSinceVersionSource: ${{ steps.gitversion.outputs.commitsSinceVersionSource }}"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build Solution
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-restore \
          /p:Version=${{ steps.gitversion.outputs.semVer }} \
          /p:AssemblyVersion=${{ steps.gitversion.outputs.assemblySemVer }} \
          /p:FileVersion=${{ steps.gitversion.outputs.assemblySemFileVer }} \
          /p:InformationalVersion=${{ steps.gitversion.outputs.informationalVersion }}

    - name: Run Tests with Coverage
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=TestResults.trx"

    - name: Install ReportGenerator
      run: dotnet tool install --global dotnet-reportgenerator-globaltool --ignore-failed-sources

    - name: Generate Coverage Report
      if: always()
      run: |
        reportgenerator \
          -reports:"./TestResults/**/coverage.cobertura.xml" \
          -targetdir:"./TestResults/CoverageReport" \
          -reporttypes:"HtmlInline;Cobertura;Badges;MarkdownSummaryGithub;TextSummary"

    - name: Display Coverage Summary
      if: always()
      run: |
        echo "==================================================="
        echo "           TEST AND COVERAGE SUMMARY"
        echo "==================================================="
        if [ -f "./TestResults/CoverageReport/Summary.txt" ]; then
          cat "./TestResults/CoverageReport/Summary.txt"
        fi
        echo "==================================================="

    - name: Add Coverage PR Comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        path: ./TestResults/CoverageReport/SummaryGithub.md

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          TestResults/**/*.trx
        check_name: 'Test Results'
        comment_title: 'Test Results'

    - name: Code Coverage Report
      uses: irongut/CodeCoverageSummary@v1.3.0
      if: always()
      with:
        filename: TestResults/CoverageReport/Cobertura.xml
        badge: true
        fail_below_min: false
        format: markdown
        hide_branch_rate: false
        hide_complexity: false
        indicators: true
        output: both
        thresholds: '60 80'

    - name: Add Coverage to Job Summary
      if: always()
      run: |
        if [ -f "code-coverage-results.md" ]; then
          cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: TestResults/**/*.trx
        retention-days: 30

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: TestResults/CoverageReport/
        retention-days: 30

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        files: ./TestResults/CoverageReport/Cobertura.xml
        flags: unittests
        name: codecov-hexgrid
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}  # Optional for public repos

    - name: Publish Build Artifacts
      run: |
        dotnet publish HexGrid.Lib/HexGrid.Lib.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-build \
          --output ./publish \
          /p:Version=${{ steps.gitversion.outputs.semVer }}

    - name: Create NuGet Package
      run: |
        dotnet pack HexGrid.Lib/HexGrid.Lib.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-build \
          --output ./packages \
          /p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersion }} \
          /p:Version=${{ steps.gitversion.outputs.semVer }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hexgrid-lib
        path: ./publish/
        retention-days: 30

    - name: Upload NuGet Package
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: ./packages/*.nupkg
        retention-days: 90

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success()
    
    steps:
    - name: Download Coverage Report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: ./CoverageReport

    - name: Quality Gate Check
      run: |
        echo "Quality Gate Checks"
        echo "==================="
        
        # Parse coverage from Summary.txt
        if [ -f "./CoverageReport/Summary.txt" ]; then
          cat "./CoverageReport/Summary.txt"
          
          # Example: Extract line coverage percentage
          if grep -q "Line coverage:" "./CoverageReport/Summary.txt"; then
            COVERAGE=$(grep "Line coverage:" "./CoverageReport/Summary.txt" | grep -oP '\d+\.?\d*%' | head -1 | tr -d '%')
            echo ""
            echo "Line Coverage: ${COVERAGE}%"
            
            # Optional: Fail if coverage is below threshold
            # if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            #     echo "Coverage is below 60% threshold!"
            #     exit 1
            # fi
          fi
        fi
        
        echo ""
        echo " Quality gate passed!"
